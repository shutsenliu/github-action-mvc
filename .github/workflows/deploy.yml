name: Build and Deploy .NET Core App

on:
  push:
    branches:
      - main      # æ­£å¼ç’°å¢ƒéƒ¨ç½²
      - develop   # æ¸¬è©¦ç’°å¢ƒéƒ¨ç½²

env:
  DOTNET_VERSION: '8.0.x'      # æˆ‘å€‘ç”¨çš„ .NET ç‰ˆæœ¬
  GLOBAL_TIMEOUT: 300          # å…¨åŸŸè®Šæ•¸ï¼šå…¨éƒ¨æ­¥é©Ÿå¯ç”¨

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # æ ¹æ“šåˆ†æ”¯æ±ºå®šéƒ¨ç½²åˆ°å“ªå€‹ç’°å¢ƒ
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}

    steps:
    - name: 1ï¸âƒ£ å–å¾—åŸå§‹ç¢¼
      uses: actions/checkout@v3

    - name: 2ï¸âƒ£ å®‰è£ .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 3ï¸âƒ£ é‚„åŸç›¸ä¾å¥—ä»¶
      run: dotnet restore

    - name: 4ï¸âƒ£ å»ºç½®å°ˆæ¡ˆ
      run: dotnet build --configuration Release

    - name: 5ï¸âƒ£ åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      run: dotnet test

    - name: 6ï¸âƒ£ ç™¼ä½ˆç¶²ç«™ï¼ˆè¼¸å‡ºåˆ° publish è³‡æ–™å¤¾ï¼‰
      run: dotnet publish -c Release -o ./publish

    - name: 7ï¸âƒ£ éƒ¨ç½²ç¶²ç«™
      env:
        DEPLOY_API_KEY: ${{ secrets.DEPLOY_API_KEY }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_HOST: ${{ vars.DB_HOST }}
        API_BASE_URL: ${{ vars.API_BASE_URL }}
      run: |
        echo "ğŸ” ä½¿ç”¨é‡‘é‘° $DEPLOY_API_KEY"
        echo "ğŸŒ éƒ¨ç½²åˆ° API $API_BASE_URL"
        echo "ğŸ›¢ é€£ç·šè³‡æ–™åº«ï¼š$DB_HOST"
        echo "ğŸ“¦ ç™¼ä½ˆè³‡æ–™å¤¾ï¼š./publish"
        # é€™è£¡å¯ä»¥æ”¾ä½ çš„éƒ¨ç½²å‘½ä»¤ï¼Œä¾‹å¦‚ Azure CLIã€FTP ç­‰
